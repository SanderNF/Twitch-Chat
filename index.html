<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        async function fetchChat() {
                try {
                    fetch("./Chat.json")
                        //.then(res => res.json())
                        .then(res => {
                            //res = res.json();
                            //console.log(res);
                            if (res.status === 200) {
                                return res.json();
                            }
                            return Promise.reject(new Error('HTTP status ' + res.status));
                        })
                        .then(data => {
                            const Chat = data;
                            const oldChat = document.getElementById("Chat");
                            const pageMessages = document.querySelectorAll(".message");
                            //console.log(`old chat: ${oldChat.innerHTML}`); // Log the old chat
                            //console.log(`new chat: ${Chat}`); // Log the new chat

                            
                            if (Chat != oldChat.innerHTML){
                                for (let k = 0; k < Chat.length; k++) {
                                    if (Chat[k].id.substring(Chat[k].id.length - 8) === "-deleted") {
                                        const delMsg = document.getElementById(Chat[k].id.replace("-deleted", ""));
                                        if (delMsg) {
                                            delMsg.lastChild.innerHTML = "<i>Message deleted</i>";
                                        }
                                    } else {
                                        const msg = document.createElement("div");
                                        msg.classList.add("message");
                                        msg.innerHTML = Chat[k].msg;
                                        msg.id = `${Chat[k].id}`;
                                        //msg.style.marginBottom = "-50px";
                                        //msg.style.transition = "margin-bottom 0.5s ease-out";
                                        //console.log(`adding chat: ${Chat[k]}`); // Log the new chat
                                        if (document.getElementById(msg.id)) {
                                            //console.log(`skipping duplicate id: ${msg.id}`);
                                            continue;
                                        }
                                        document.getElementById("Chat").appendChild(msg);
                                        setTimeout(() => {
                                            msg.classList.add("mover");
                                        }, 20); // Slight delay to ensure the transition occurs
                                    }
                                }
                            }
                            setTimeout(() => {
                                for (let i = 0; i < (document.querySelectorAll(".message").length - 6); i++) {
                                    //console.log(`removing old message: ${document.querySelectorAll(".message")[i].id}`);
                                    document.querySelectorAll(".message")[i].remove();
                                }
                            }, 100);
                        })
                        .catch(error => console.error(error));
                }
                catch (error) {
                    console.error(error);
                }
            }
    </script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="Chat"></div>
</body>
<script>
    fetchChat()
    setInterval(fetchChat, 100)
</script>
</html>