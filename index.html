<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        async function fetchChat() {
                try {
                    fetch("./Chat.json")
                        //.then(res => res.json())
                        .then(res => {
                            //res = res.json();
                            //console.log(res);
                            if (res.status === 200) {
                                return res.json();
                            }
                            return Promise.reject(new Error('HTTP status ' + res.status));
                        })
                        .then(data => {
                            drawChatbox(data);
                        })
                        .catch(error => console.error(error));
                }
                catch (error) {
                    console.error(error);
                }
            }
        async function offsetChat() {
            const chatbox = document.getElementById('Chat');
            setTimeout(() => {
                let chatList = []
                for (let msg of chatbox.children) {
                    time = msg.classList[2].split("ยง")[1];
                    chatList.push({Element: msg, Time: parseInt(time)});
                }
                chatList.sort((a, b) => b.Time - a.Time);
                let offset = 40;
                for (let msg of chatList) {
                    Height = msg.Element.offsetHeight;
                    //offset += Height;
                    msg.Element.style.bottom = `${offset}px`;
                    offset += 10 + Height; // Additional spacing between messages
                }
                //console.log(chatList);                  
            }, 100);
        }
        function drawChatbox(jsonData) {
            const chatbox = document.getElementById('Chat');
            let chatIds = []
            for (let msg of chatbox.children) {
                chatIds.push(msg.id);
            }
            for (let id of chatIds) {
                if (!jsonData.some(message => message.id === id)) {
                    const msgDiv = document.getElementById(id);
                    msgDiv.classList.add('hide');
                    setTimeout(() => {
                        msgDiv.remove();
                        offsetChat();
                    }, 1000); // Make this duration more than the CSS transition duration
                }
            }
            jsonData.forEach(message => {
                if (message.id.substring(message.id.length - 8) === "-deleted") {
                    const delMsg = document.getElementById(message.id.replace("-deleted", ""));
                    if (delMsg) {
                        delMsg.lastChild.lastChild.lastChild.innerHTML = "<p><i>Message deleted</i></p>";
                    }
                } else {
                    if (chatIds.includes(message.id)) {
                        
                    } else {
                        const msgDiv = document.createElement('div');
                        msgDiv.classList.add('message');
                        msgDiv.innerHTML = message.msg; // Assuming message.msg contains the HTML content
                        msgDiv.classList.add('startPos');
                        msgDiv.id = message.id;
                        chatbox.appendChild(msgDiv);
                        divHeight = msgDiv.offsetHeight;
                        console.log(divHeight);
                        //msgDiv.style.bottom = `${divHeight}px`;
                        msgDiv.classList.add(`Time:ยง${Date.now()}`)
                        console.log(`${Date.now()}`)
                        offsetChat();
                    }}
            });
            
        }
    </script>
    <link rel="stylesheet" href="style.css">
    <style>
        
    </style>
</head>
<body>
    <div id="Chat"></div>
</body>
<script>
    fetchChat()
    setInterval(fetchChat, 100)
</script>
</html>