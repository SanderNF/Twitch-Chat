<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script>
        console.log(window.location.href);
        var url = window.location;
        let params = new URLSearchParams(url.search);
        let code = params.has('code') ? params.get('code') : null;
        if (code !== null) {
            localStorage.setItem('twitch_token', code);
        }
        console.log('Code param present:', code);
        async function authTwitch() {
            if (localStorage.getItem('twitch_client_id')) {
                const CLIENT_ID = localStorage.getItem('twitch_client_id');
            } else {
                const CLIENT_ID = prompt('Enter your Twitch Client ID: ',"client_id_here");
                localStorage.setItem('twitch_client_id', CLIENT_ID);
            }
            if (localStorage.getItem('twitch_secret')) {
                const CLIENT_SECRET = localStorage.getItem('twitch_secret');
            } else {
                const CLIENT_SECRET = prompt('Enter your Twitch Client Secret: ',"client_secret_here");
                localStorage.setItem('twitch_secret', CLIENT_SECRET);
            }
            const REDIRECT_URI = 'http://localhost:5502/Naitive_web.html'; // Change as needed
            try {
                const response = await fetch(`https://id.twitch.tv/oauth2/token`, {
                    method: 'POST',
                    body: JSON.stringify({
                        client_id: localStorage.getItem('twitch_client_id'),
                        client_secret: localStorage.getItem('twitch_secret'),
                        code: localStorage.getItem('twitch_token'),
                        redirect_uri: REDIRECT_URI,
                        grant_type: 'authorization_code'
                    }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                //const response = await fetch(`https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=chat:read+chat:edit`, {
                //    method: 'GET',
                //    headers: {
                //        'Content-Type': 'application/json'
                //    }
                //});

                if (response.ok) {
                    const data = await response.json();
                    console.log('Twitch Auth Response:', data);
                    //localStorage.setItem('twitch_token', data.access_token);
                    console.log(localStorage.getItem('twitch_token'));

                } else {
                    console.error('Twitch Auth Error:', response.status, response.statusText);
                }
            } catch (error) {
                console.error('Fetch Error:', error);
            }
        }
    

        function eventSubMessage() {
            const TOKEN = localStorage.getItem('twitch_token') || prompt('Enter Twitch OAuth token (Bearer):','');
            localStorage.setItem('twitch_token', TOKEN);
            const CLIENT_ID = localStorage.getItem('twitch_client_id') || prompt('Enter Twitch Client ID:','');
            if (!localStorage.getItem('twitch_client_id')) localStorage.setItem('twitch_client_id', CLIENT_ID);

            console.log('Using TOKEN:', TOKEN);

            const payload = {
                type: "channel.chat.message",
                version: "1",
                condition: {
                    broadcaster_user_id: "12826",
                    user_id: "141981764"
                },
                transport: {
                    method: "webhook",
                    callback: "https://your-webhook-handling-server.com",
                    secret: localStorage.getItem('twitch_secret') || 'your_webhook_secret'
                }
            };

            fetch('https://api.twitch.tv/helix/eventsub/', {
                method: 'POST',
                headers: {
                    "type": "user.update",
                    "version": "1",
                    'Authorization': `Bearer ${TOKEN}`,
                    'Client-Id': CLIENT_ID,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(async res => {
                const data = await res.json().catch(() => ({}));
                if (res.ok) console.log('EventSub created:', data);
                else if (res.status === 403) {
                    window.location.href = `https://id.twitch.tv/oauth2/authorize?response_type=code&client_id=${localStorage.getItem('twitch_client_id')}&redirect_uri=${window.location.href}&scope=user%3Aread%3Achat+channel%3Abot+channel%3Amanage%3Apolls+channel%3Aread%3Apolls`
                }
                else console.error('EventSub error:', res.status, data);
            })
            .catch(err => console.error('Fetch error:', err));
        }
    </script>
</head>
<body onload="authTwitch()">
    <button onclick="eventSubMessage()">Subscribe to Chat Messages</button>
    
</body>
</html>